{% extends "base.html" %}
{% block title %}Conversation | {{ block.super }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8">
    <div class="d-flex align-items-center mb-3">
      <div>
        <h5 class="mb-0">
          {{ conversation.title|default:other_user.get_full_name|default:other_user.username|default:"Direct message" }}
        </h5>
        <small class="text-muted">
          {% if other_user %}
            {{ other_user.username }}{% if other_user.email %} â€¢ {{ other_user.email }}{% endif %}
          {% else %}
            Conversation
          {% endif %}
        </small>
      </div>
      <div class="ms-auto">
        <form method="post" action="{% url 'messages:mark_read' conversation.pk %}">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-secondary">Mark read</button>
        </form>
      </div>
    </div>

    <div id="messages-list" class="mb-3 d-flex flex-column gap-3">
      {% for msg in messages %}
        {% if msg.sender == user %}
          <div class="d-flex justify-content-end align-items-end message-row">
            <div class="message-meta text-end me-2">
              <small class="text-muted d-block">You</small>
              <small class="text-muted">{{ msg.created_at|date:"d.m.Y H:i" }}</small>
            </div>

            <div class="message-bubble message-me">
              {% if msg.is_deleted %}
                <em class="text-muted">Message removed</em>
              {% else %}
                {{ msg.display_text|linebreaksbr }}
              {% endif %}
            </div>

            <div class="ms-2 d-none d-sm-flex align-items-end">
              {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="avatar" class="rounded-circle msg-avatar">
              {% else %}
                <div class="rounded-circle msg-avatar avatar-initials">{{ user.username|default:user.email|slice:":1"|upper }}</div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="d-flex align-items-start message-row">
            <div class="me-2 d-none d-sm-flex align-items-start">
              {% if msg.sender.avatar %}
                <img src="{{ msg.sender.avatar.url }}" alt="avatar" class="rounded-circle msg-avatar">
              {% else %}
                <div class="rounded-circle msg-avatar avatar-initials">{{ msg.sender.username|slice:":1"|upper }}</div>
              {% endif %}
            </div>

            <div>
              <div class="message-meta mb-1">
                <strong class="sender-name">{{ msg.sender.get_full_name|default:msg.sender.username }}</strong>
                <div class="small text-muted">{{ msg.created_at|date:"d.m.Y H:i" }}</div>
              </div>

              <div class="message-bubble message-other">
                {% if msg.is_deleted %}
                  <em class="text-muted">Message removed</em>
                {% else %}
                  {{ msg.display_text|linebreaksbr }}
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="mt-4">
      {% if user.is_authenticated %}
        <form id="message-send-form" method="post" action="{% url 'messages:send_message' conversation.pk %}">
          {% csrf_token %}
          {{ form.as_p }}
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Send</button>
            <button class="btn btn-outline-secondary" type="reset">Clear</button>
          </div>
        </form>
      {% else %}
        <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-outline-primary">Login to reply</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.msg-avatar {
  width:40px; height:40px; object-fit:cover;
}
.avatar-initials {
  width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
  background:#e9ecef; color:#495057; font-weight:700; border-radius:50%;
}
.message-row { max-width:100%; }
.message-bubble {
  max-width:78ch;
  padding:10px 14px;
  border-radius:14px;
  box-shadow: 0 6px 18px rgba(20,20,20,0.04);
  word-break:break-word;
}
.message-me {
  background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); /* blue gradient */
  color: #fff;
  border-bottom-right-radius:6px;
}
.message-other {
  background: #f8fafc; /* light */
  color: #111827;
  border-bottom-left-radius:6px;
}
.sender-name { display:inline-block; margin-right:.5rem; }
.message-meta small { display:block; }
#messages-list { max-height: 65vh; overflow:auto; padding-right:6px; }
</style>
{% endblock %}
