{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.title }} | {{ block.super }}{% endblock %}

{% block content %}

<div class="card shadow-sm mx-auto" style="max-width: 1780px;">
  <h1 class="card-title text-center">{{ post.title }}</h1>

  {% if post.image %}
    <div class="text-center mt-3">
      <img src="{{ post.image.url }}"
           alt="{{ post.title }}"
           class="rounded shadow-sm"
           loading="lazy"
           decoding="async"
           style="width: 25%; max-width: 1150px; height: auto; cursor: pointer; object-fit: cover;"
           data-bs-toggle="modal"
           data-bs-target="#fullscreenImageModal">
    </div>
  {% endif %}

  <div class="card-body">
    <div class="text-center text-muted small mb-3">
      <span class="me-2">by</span>
      <a href="{% url 'users:author_profile' post.user.username %}"
         class="text-decoration-none fw-semibold text-primary">
        {{ post.user.get_full_name|default:post.user.username|default:post.user.email }}
      </a>
      <span class="mx-2">&bull;</span>
      <span>{{ post.created_at|date:"d.m.Y H:i" }}</span>
    </div>

    <p class="card-text">{{ post.text|linebreaks }}</p>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <div>
        {% include "apps/likes/like_button.html" with post=post %}
      </div>

      {% if user == post.user %}
        <div>
          <a href="{% url 'posts:edit' post.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
          <a href="{% url 'posts:delete' post.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
        </div>
      {% endif %}
    </div>

 {% if post.tags.all %}
  <div class="post-tags mt-3">
    {% for tag in post.tags.all %}
     <a href="{% url 'posts:by_tag' tag.name|lower|urlencode %}">#{{ tag.name }}</a>
    {% endfor %}
  </div>
{% endif %}

  </div>
</div>

<div class="container mt-4">
  {% include "apps/comments/comment_list.html" with post=post form=form %}
</div>

<div class="text-center mt-3">
  <a href="{% url 'posts:list' %}" class="btn btn-link">← Back to posts</a>
</div>

{% if post.image %}
  <div class="modal fade" id="fullscreenImageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark border-0 position-relative">
        <div class="modal-body p-0 d-flex align-items-center justify-content-center">
          <img src="{{ post.image.url }}"
               alt="{{ post.title }}"
               class="img-fluid rounded shadow-lg"
               style="max-height: 100vh; object-fit: contain;">
        </div>
      </div>
    </div>

    <button type="button"
            class="btn btn-light close-fullscreen"
            data-bs-dismiss="modal"
            aria-label="Close">✕</button>
  </div>
{% endif %}

{% endblock %}


{% block extra_css %}
{{ block.super }}
<style>
  .modal-backdrop.fullscreen-fix { z-index: 1050 !important; }
  #fullscreenImageModal { z-index: 1060 !important; }
  #fullscreenImageModal .modal-dialog { z-index: 1061 !important; }
  #fullscreenImageModal .modal-content { z-index: 1062 !important; pointer-events:auto; }


  .close-fullscreen {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1070 !important;
    pointer-events: auto !important;
    box-shadow: 0 .25rem .5rem rgba(0,0,0,.25);
    border-radius: .5rem;
    padding: .4rem .6rem;
    background: rgba(255,255,255,0.95);
    border: 0;
  }

  @media (max-width: 576px) {
    .close-fullscreen {
      right: 12px;
      bottom: 12px;
    }
  }

  .navbar { position: relative; z-index: 1000 !important; }
  .navbar .dropdown-menu, .dropdown-menu.show { z-index: 1100 !important; }

    .post-tags .badge {
      font-size: 1rem;
      font-weight: 700;
      padding: .35rem .6rem;
      border-radius: .5rem;
      line-height: 1;
      display: inline-block;
    }
    .post-tags .badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      text-decoration: none;
    }
    .post-tags .badge.bg-primary {
      background: var(--bs-primary);
      color: #fff;
    }
</style>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
(function(){
  if (!window.bootstrap) return;

  document.addEventListener('DOMContentLoaded', function () {
    var modalEl = document.getElementById('fullscreenImageModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', function () {
      setTimeout(function () {
        var backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length) {
          backdrops[backdrops.length - 1].classList.add('fullscreen-fix');
        }
      }, 0);
      document.body.classList.remove('dropdown-open');
    });

    var btn = document.querySelector('#fullscreenImageModal + .close-fullscreen, #fullscreenImageModal .close-fullscreen');
    if (btn) {
      btn.addEventListener('click', function (e) {
        var inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        inst.hide();
      });
    }
  });
})();
</script>
{% endblock %}
